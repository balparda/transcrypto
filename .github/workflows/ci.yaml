# SPDX-FileCopyrightText: Copyright 2026 Daniel Balparda <balparda@github.com>
# SPDX-License-Identifier: Apache-2.0

name: ci

permissions:
  contents: read

on:
  push:
  pull_request:

jobs:

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.13', '3.14']

    steps:

      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install Poetry
        run: pip install poetry

      - name: Install deps
        run: poetry install

      - name: Lint
        run: poetry run ruff check .

      - name: Format
        run: poetry run ruff format --check .

      - name: Typecheck
        run: poetry run mypy src

      - name: Tests w/ typeguard & Coverage
        run: poetry run pytest --typeguard-packages=transcrypto --cov=src --cov-report=term-missing -q tests

  integration:
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.13', '3.14']

    steps:

      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install Poetry
        run: pip install poetry

      - name: Install deps
        run: poetry install

      - name: Build wheel
        run: poetry build -f wheel

      - name: Integration tests (installed CLI)
        run: poetry run pytest -q tests_integration
